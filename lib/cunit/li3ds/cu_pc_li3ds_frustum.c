/***********************************************************************
* cu_pc_frustum.c
*
*        Testing for the frustum API functions
*
* Copyright (c) 2017, Mathieu Br√©dif, IGN
*
***********************************************************************/

#include "CUnit/Basic.h"
#include "../cu_tester.h"

/* GLOBALS ************************************************************/

#define N (5)
const PCBOX3 b[N] = {
	{ {  0, 0, 0 }, {  3, 4, 5 } },
	{ {  9,10,11 }, { 12,13,14 } },
	{ { -1,-1,-1 }, {  1, 1, 1 } },
	{ { 0,0,0 }, {  2, 2, 2 } },
	{ { 1,1,1 }, {  2, 3, 3 } }
};

PCFRUSTUM f[N];

/* Setup/teardown for this suite */
static int
init_suite(void)
{
	int i = 0;
	for( i = 0; i < N; ++i )
		pc_frustum_from_box(f+i,b[i]);

	// TODO: non axis aligned frustums

	return 0;
}

static int
clean_suite(void)
{
	return 0;
}


/* TESTS **************************************************************/

static void
test_frustum_wkb_expected(PCFRUSTUM *frustum, const char *expected)
{
	size_t wkbsize;
	uint8_t *wkb;
	char *hexbytes;
	uint32_t srid = 0;
	wkb = pc_frustum_to_geometry_wkb(frustum,srid,&wkbsize);
	hexbytes = hexbytes_from_bytes(wkb,wkbsize);

	if(expected)
		CU_ASSERT_STRING_EQUAL(hexbytes,expected);

	pcfree(hexbytes);
	pcfree(wkb);
}

static void
test_frustum_wkb()
{
	int i;
	const char *expected[] = {
		"010F00008006000000010300008001000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000104000000000000000000000000000000000000000000000000000000000000014400000000000000000000000000000104000000000000014400000000000000000000000000000000000000000000000000103000080010000000500000000000000000008400000000000000000000000000000000000000000000008400000000000001040000000000000000000000000000008400000000000000000000000000000144000000000000008400000000000001040000000000000144000000000000008400000000000000000000000000000000001030000800100000005000000000000000000000000000000000000000000000000000000000000000000084000000000000000000000000000000000000000000000000000000000000000000000000000001440000000000000084000000000000000000000000000001440000000000000000000000000000000000000000000000000010300008001000000050000000000000000000000000000000000104000000000000000000000000000000840000000000000104000000000000000000000000000000000000000000000104000000000000014400000000000000840000000000000104000000000000014400000000000000000000000000000104000000000000000000103000080010000000500000000000000000000000000000000000000000000000000000000000000000008400000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000008400000000000001040000000000000000000000000000000000000000000000000000000000000000001030000800100000005000000000000000000000000000000000000000000000000001440000000000000084000000000000000000000000000001440000000000000000000000000000010400000000000001440000000000000084000000000000010400000000000001440000000000000000000000000000000000000000000001440",
		"010F000080060000000103000080010000000500000000000000000022400000000000002440000000000000264000000000000022400000000000002A400000000000002640000000000000224000000000000024400000000000002C4000000000000022400000000000002A400000000000002C400000000000002240000000000000244000000000000026400103000080010000000500000000000000000028400000000000002440000000000000264000000000000028400000000000002A400000000000002640000000000000284000000000000024400000000000002C4000000000000028400000000000002A400000000000002C4000000000000028400000000000002440000000000000264001030000800100000005000000000000000000224000000000000024400000000000002640000000000000284000000000000024400000000000002640000000000000224000000000000024400000000000002C40000000000000284000000000000024400000000000002C400000000000002240000000000000244000000000000026400103000080010000000500000000000000000022400000000000002A40000000000000264000000000000028400000000000002A40000000000000264000000000000022400000000000002A400000000000002C4000000000000028400000000000002A400000000000002C4000000000000022400000000000002A4000000000000026400103000080010000000500000000000000000022400000000000002440000000000000264000000000000028400000000000002440000000000000264000000000000022400000000000002A40000000000000264000000000000028400000000000002A40000000000000264000000000000022400000000000002440000000000000264001030000800100000005000000000000000000224000000000000024400000000000002C40000000000000284000000000000024400000000000002C4000000000000022400000000000002A400000000000002C4000000000000028400000000000002A400000000000002C40000000000000224000000000000024400000000000002C40",
		"010F0000800600000001030000800100000005000000000000000000F0BF000000000000F0BF000000000000F0BF000000000000F0BF000000000000F03F000000000000F0BF000000000000F0BF000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F000000000000F03F000000000000F0BF000000000000F0BF000000000000F0BF01030000800100000005000000000000000000F03F000000000000F0BF000000000000F0BF000000000000F03F000000000000F03F000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F000000000000F03F000000000000F03F000000000000F03F000000000000F03F000000000000F0BF000000000000F0BF01030000800100000005000000000000000000F0BF000000000000F0BF000000000000F0BF000000000000F03F000000000000F0BF000000000000F0BF000000000000F0BF000000000000F0BF000000000000F03F000000000000F03F000000000000F0BF000000000000F03F000000000000F0BF000000000000F0BF000000000000F0BF01030000800100000005000000000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F000000000000F03F000000000000F0BF000000000000F0BF000000000000F03F000000000000F03F000000000000F03F000000000000F03F000000000000F03F000000000000F0BF000000000000F03F000000000000F0BF01030000800100000005000000000000000000F0BF000000000000F0BF000000000000F0BF000000000000F03F000000000000F0BF000000000000F0BF000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F000000000000F03F000000000000F0BF000000000000F0BF000000000000F0BF000000000000F0BF01030000800100000005000000000000000000F0BF000000000000F0BF000000000000F03F000000000000F03F000000000000F0BF000000000000F03F000000000000F0BF000000000000F03F000000000000F03F000000000000F03F000000000000F03F000000000000F03F000000000000F0BF000000000000F0BF000000000000F03F",
		"010F00008006000000010300008001000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000004000000000000000400000000000000000000000000000000000000000000000000103000080010000000500000000000000000000400000000000000000000000000000000000000000000000400000000000000040000000000000000000000000000000400000000000000000000000000000004000000000000000400000000000000040000000000000004000000000000000400000000000000000000000000000000001030000800100000005000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000004000000000000000000000000000000040000000000000000000000000000000000000000000000000010300008001000000050000000000000000000000000000000000004000000000000000000000000000000040000000000000004000000000000000000000000000000000000000000000004000000000000000400000000000000040000000000000004000000000000000400000000000000000000000000000004000000000000000000103000080010000000500000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000400000000000000040000000000000000000000000000000000000000000000000000000000000000001030000800100000005000000000000000000000000000000000000000000000000000040000000000000004000000000000000000000000000000040000000000000000000000000000000400000000000000040000000000000004000000000000000400000000000000040000000000000000000000000000000000000000000000040",
		"010F0000800600000001030000800100000005000000000000000000F03F000000000000F03F000000000000F03F000000000000F03F0000000000000840000000000000F03F000000000000F03F000000000000F03F0000000000000840000000000000F03F00000000000008400000000000000840000000000000F03F000000000000F03F000000000000F03F010300008001000000050000000000000000000040000000000000F03F000000000000F03F00000000000000400000000000000840000000000000F03F0000000000000040000000000000F03F00000000000008400000000000000040000000000000084000000000000008400000000000000040000000000000F03F000000000000F03F01030000800100000005000000000000000000F03F000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F000000000000F03F000000000000F03F00000000000008400000000000000040000000000000F03F0000000000000840000000000000F03F000000000000F03F000000000000F03F01030000800100000005000000000000000000F03F0000000000000840000000000000F03F00000000000000400000000000000840000000000000F03F000000000000F03F00000000000008400000000000000840000000000000004000000000000008400000000000000840000000000000F03F0000000000000840000000000000F03F01030000800100000005000000000000000000F03F000000000000F03F000000000000F03F0000000000000040000000000000F03F000000000000F03F000000000000F03F0000000000000840000000000000F03F00000000000000400000000000000840000000000000F03F000000000000F03F000000000000F03F000000000000F03F01030000800100000005000000000000000000F03F000000000000F03F00000000000008400000000000000040000000000000F03F0000000000000840000000000000F03F00000000000008400000000000000840000000000000004000000000000008400000000000000840000000000000F03F000000000000F03F0000000000000840"
	};
	for( i = 0; i < N; ++i )
		test_frustum_wkb_expected(f+i,expected[i]);
}

static void
test_frustum_is_valid()
{
	int i;
	for( i = 0; i < N; ++i )
		pc_frustum_is_valid(f+i);
}

static void
test_frustum_intersects()
{
	int i, j, mode;
	int expected[] = {
		1,0,1,1,1,
		0,1,0,0,0,
		1,0,1,1,1,
		1,0,1,1,1,
		1,0,1,1,1,

		1,0,1,1,1,
		0,1,0,0,0,
		1,0,1,1,1,
		1,0,1,1,1,
		1,0,1,1,1,

		1,0,1,1,1,
		0,1,0,0,0,
		1,0,1,1,1,
		1,0,1,1,1,
		1,0,1,1,1,

		1,0,1,1,1,
		0,1,0,0,0,
		1,0,1,1,1,
		1,0,1,1,1,
		1,0,1,1,1,
	};
	for( mode = 1; mode < 5; ++mode )
		for( i = 0; i < N; ++i )
			for( j = 0; j < N; ++j )
				CU_ASSERT( pc_frustum_intersects(f+i,f+j,mode) == expected[i+N*(j+N*(mode-1))] );
}

static void
test_frustum_contains()
{
	int i, j;
	int expected[] = {
		1,0,0,0,0,
		0,1,0,0,0,
		0,0,1,0,0,
		1,0,0,1,0,
		1,0,0,0,1
	};
	for( i = 0; i < N; ++i )
		for( j = 0; j < N; ++j )
			CU_ASSERT( pc_frustum_contains(f+i,f+j) == expected[N*j+i] );
}

static void
test_frustum_volume()
{
	int i;
	for( i = 0; i < N; ++i )
	{
		double bv = pc_box_volume(b[i]);
		double fv = pc_frustum_volume(f+i);
		CU_ASSERT_DOUBLE_EQUAL( bv, fv, 0.0000001 );
	}
}

/* REGISTER ***********************************************************/

CU_TestInfo li3ds_frustum_tests[] = {
	PC_TEST(test_frustum_wkb),
	PC_TEST(test_frustum_is_valid),
	PC_TEST(test_frustum_intersects),
	PC_TEST(test_frustum_contains),
	PC_TEST(test_frustum_volume),
	CU_TEST_INFO_NULL
};

CU_SuiteInfo li3ds_frustum_suite = {
	.pName = "li3ds_frustum",
	.pInitFunc = init_suite,
	.pCleanupFunc = clean_suite,
	.pTests = li3ds_frustum_tests
};
